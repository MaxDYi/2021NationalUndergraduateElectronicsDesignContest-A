# 2021年全国大学生电子设计竞赛A题国二

## 0.目录  
**1. 前言**  
**2. 团队介绍**  
**3. 项目分析**  
**4. 原理图电路分析**  
**5. PCB设计分析**  
**6. 实物展示**  
**7. 作品装配**  
**8. 程序设计**  
**9. 总结**  

## 1.前言
&emsp;&emsp;本次作品为2021年全国大学生电子设计竞赛A题信号失真度测量装置，由于比赛时间紧张，作品制作粗糙。作品最终获得北京赛区一等奖，全国二等奖。这也是第一次开源项目，欢迎大家提出问题一起讨论。演示视频投稿至b站[演示视频](https://www.bilibili.com/video/BV1wP4y1H7mS/)。

## 2.团队介绍

&emsp;&emsp;团队成员：马丁一，孙玉丽，凌昊。  
&emsp;&emsp;马丁一，北京交通大学电子信息工程学院自动化专业。主要负责单片机开发。  
&emsp;&emsp;孙玉丽，电子科学与技术专业，主要负责硬件部分，比如电路设计、器件选型、电路焊接等工作。  
&emsp;&emsp;凌昊，就读于北京交通大学电子信息工程学院通信工程专业，在队内主要负责单片机方向；从大三寒假开始准备电赛，期间做过巡线小车、2019年电赛C题、D题作品，完成电子设计竞赛校内赛差分放大电路测试仪，最终迎接国赛，完成A题信号失真度测量装置的制作。  

## 3.项目分析
### 3.1 基本要求
&emsp;&emsp;（1）输入信号的峰峰值电压范围：300mV-600mV。  
&emsp;&emsp;（2）输入信号基频：1kHz。  
&emsp;&emsp;（3）输入信号失真度范围：5%~50%。  
&emsp;&emsp;（4）要求对输入信号失真度测量误差绝对值|THDx-THDo|≤5%，THDx和THDo分别为失真度的测量值与标称值。  
&emsp;&emsp;（5）显示失真度测量值THDx。  
&emsp;&emsp;（6）失真度测量与显示用时不超过10秒。  

### 3.2 发挥部分
&emsp;&emsp;（1）输入信号的峰峰值电压范围：30mV-600mV。  
&emsp;&emsp;（2）输入信号基频范围：1kHz-100kHz。  
&emsp;&emsp;（3）测量并显示输入信号失真度THDx值，要求|THDx-THDo|≤3%。  
&emsp;&emsp;（4）测量并显示输入信号的一个周期波形。  
&emsp;&emsp;（5）显示输入信号基波与谐波的归一化幅值，只显示到5次谐波。  
&emsp;&emsp;（6）在手机上显示测量装置测得并显示的输入信号THDx值、一个周期波形、基波与谐波的归一化幅值。  
&emsp;&emsp;（7）其他。  

### 3.3 分析
&emsp;&emsp;本题要求用于信号失真度测量的主控制器和数据采集器必须使用 TI 公司的MCU及其片内ADC，不得使用其他片外ADC和数据采集模块（卡）成品，故信号采集模块的MCU均在TI公司生产的处理器系列中选择。  
&emsp;&emsp;考虑到题目要求测量的最高信号频率为100kHz，五次谐波满足奈奎斯特采样定理需要采样频率达到1MHz，故选择C2000系列处理器作为主控芯片，并使用其片内ADC进行采样。C2000是TI公司生产的32位高性能实时微控制器，具有片内12位ADC，主时钟频率可达到200MHz，运行速度比较快，实时性比较好。由于实验室中正好有28379D的开发板，故选择此开发板。开发板资料见[LAUNCHXL-F28379D](https://www.ti.com.cn/tool/cn/LAUNCHXL-F28379D)。  
&emsp;&emsp;对于数据处理部分采用频域分析方法，对ADC采样值做FFT变换，得到信号中不同频率的幅值大小，代入THD计算公式得到失真度大小。该方案硬件成本低，电路简单。  

## 4.原理图电路分析
&emsp;&emsp;本次作品中电路均使用立创EDA设计，完整电路图见附件5。但仅有输入信号处理部分进行了打样（使用17年电赛设计的板子gerber文件见附件6）。
### 4.1隔直放大电路
&emsp;&emsp;如图，输入信号处理电路由RC滤波电路和同相加法器电路共同组成：在同相加法器的前面接入RC高通滤波器，将信号中可能含有的直流成分滤掉，然后再利用同相加法器将隔直后的信号抬升并放大。同相加法器电路由TI的运算放大器OPA227构成，OPA227运算放大器兼具低噪声、宽带宽和高精度等特性，是同时需要交流和精密直流性能应用的理想选择。  
&emsp;&emsp;由于题目要求输入信号的频率范围为1kHz-100kHz，峰峰值电压范围为300mV-600mV, 故RC滤波器的截频要小于1kHz，故电路图中电容器件C29取1uF，电阻器件R43取10kΩ。  
&emsp;&emsp;令R46=R45=R42=R,则同相加法器的输出电压为U0=(R41+R)/2R (U_1+U_2 ),其中U1为输入信号电压，U2为电阻分压得到的输入加法器的直流电压,约为0.33V。该电路的放大倍数：Au=(R41+R)/2R=(7k+1k)/(2×1k)=4。放大后的信号满足单片机电压采样范围0~3.3V。  

### 4.2迟滞比较器电路
&emsp;&emsp;由于提高部分要求输入信号的频率范围为1kHz~100kHz，在输入信号的频率未知情况下无法确定采样率，故利用迟滞比较器将输入的信号转变成方波，得到基波频率，进而确定采样频率然后进行后续处理。  
&emsp;&emsp;迟滞比较器电路是使用TI的比较器LM339构成的，LM339比较器可在宽电压范围内由单电源供电，漏极电流不受电源电压的影响。迟滞比较器是一个具有迟滞回环传输特性的比较器,在反相输入单门限电压比较器的基础上引入正反馈网络，就组成了具有双门限值的反相输入迟滞比较器。  
&emsp;&emsp;电路如图所示，R3与R4分压得到参考电压Vr=1.35V，R2与R1的比例及Vr决定了高低电平阈值电压，令R2/R1=10，得到高电平阈值电压约为1.5V，低电平阈值电压约为1.2V，满足输入信号的转换方波的阈值电平要求。    

## 5.PCB设计分析
&emsp;&emsp;注意事项：  
&emsp;&emsp;(1)电源线和地线尽量加粗，能够提供较大的电流。  
&emsp;&emsp;(2)线宽关系是：地线＞电源线＞信号线，通常信号线宽为：0.2～0.3mm,最经细宽度可达0.05～0.07mm,电源线为1.2～2.5 mm。  
&emsp;&emsp;(3)去耦电容尽量与VCC直接相连，并且物理距离上靠近芯片引脚。  
&emsp;&emsp;(4)数字地与模拟地尽量分开接地。  
&emsp;&emsp;(5)连线要精简，尽可能短和少拐弯。  
&emsp;&emsp;(6)外框尽量方正，预留好安装孔。  
&emsp;&emsp;由于时间关系，本次比赛的放大电路部分用了之前在立创打好的PCB板，其他部分是在洞洞板上手动焊接而成。  
&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;![PCB焊接.jpg](//image.lceda.cn/pullimage/1FYhMuZla2TF3GsZd77o02WQg7SmsAz5dQ8rSe3z.jpeg)

## 6.实物展示
&emsp;&emsp;演示视频过大投稿至b站[演示视频](https://www.bilibili.com/video/BV1wP4y1H7mS/)。  

## 7.作品装配
&emsp;&emsp;如图，红框部分是迟滞比较器部分，黄框部分是正负电源和地，蓝框部分是串口部分，左边蓝框接串口屏，右边蓝框接蓝牙。模块位置是考虑了所连接单片机引脚的位置，按照就近原则放置。装配的顺序是先焊好迟滞比较器电路和输入部分电路，然后焊接放置单片机的排母，最后引出串口排针。  
&emsp;&emsp;主要模块购买链接如下：  
&emsp;&emsp;[开发板](https://detail.tmall.com/item.htm?spm=a230r.1.14.27.6eca3d562tw6fJ&id=624725872138&ns=1&abbucket=15&skuId=4425672800866)  
&emsp;&emsp;[串口屏](https://item.taobao.com/item.htm?spm=a1z09.2.0.0.54212e8dtdHvrJ&id=630642252956&_u=92nrab05ce14)  
&emsp;&emsp;[蓝牙模块](https://detail.tmall.com/item.htm?spm=a230r.1.14.16.40f253edXYpzzc&id=24077608890&ns=1&abbucket=15)  
&emsp;&emsp;其中蓝牙模块使用HC05，与大多数蓝牙模块兼容，可使用手里有的进行测试，注意蓝牙模块供电电压。

## 8.程序设计
&emsp;&emsp;设备上电后开始执行程序，分别ADC采样和计数测量方波频率获取基频，获取被测信号时域数据和基频后做FFT变换，得到相应频域数据，在基频频域幅值基础上获取谐波频点频域幅值从而计算失真度和归一化幅值，将计算结果分别通过串口通信传递给串口屏和通过蓝牙模块传递给手机，显示计算结果；不断循环这一过程实时跟新显示数值。  
&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;![软件流程图.png](//image.lceda.cn/pullimage/XFbUBVY7saOmIXlJJXsSSg72bOjUmsFj6qAzf6fw.png)  
&emsp;&emsp;手机APP部分利用WxBit图形化编程系统制作了一个通过HC-05蓝牙模块接收数据并实时显示的APP。  
&emsp;&emsp;蓝牙模块与串口屏分别使用SCIB与SCIC。  

## 9.总结
&emsp;&emsp;首先是在三天四夜的比赛过程中，时间紧迫，很难把作品设计和实现做到面面俱到，最后的设计报告的书写也是赶出来、缺少一定质量；其次就是由于没有及时阅览组委会对赛题限制问题回答的修改（A题不可以使用除TI公司生成的单片机以外的任何单片机），造成我们在最初的设计并且已经在做的方案（C2000ADC采集信号数据，传给STM32做数据处理）上浪费了部分宝贵时间；我们在外部电路正常工作、TI单片机程序调试、串口屏和手机蓝牙显示上花费了很多的时间和耐心，细心排查问题，团队协作，幸运最终顺利完成了作品的制作。本次开源，存在不当或是有问题的地方希望小伙伴们指正，互相学习。  
&emsp;&emsp;本次电赛从寒假开始准备，到如今结束耗时一年，在备赛的过程中学到了很多。感谢团队中每一个人的付出，也在此感谢weisxint、XZhao、Kurui三位老师长达一年的培训与指导（づ￣3￣）づ╭❤～ 。
